<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dostupné akcie</title>

  <style>
    body {
      font-family: system-ui, -apple-system, Arial, sans-serif;
      margin: 0;
      background: #fff;
    }
    .wrap {
      max-width: 1000px;
      margin: 60px auto;
      padding: 0 16px;
      text-align: center;
    }
    h1 {
      margin-bottom: 16px;
    }
    input {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    .top {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }
    .row {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 14px;
      margin: 12px 0;
      display: grid;
      grid-template-columns: 140px 1fr 160px 320px;
      gap: 10px;
      align-items: center;
      text-align: left;
    }
    .muted {
      color: #666;
      font-size: 14px;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 12px;
    }
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
      background: #f6f6f6;
    }
    button.primary {
      background: #e8f3ff;
    }
    button:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    .debug {
      margin: 10px auto 16px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      max-width: 960px;
      background: #fafafa;
      text-align: left;
    }

    @media (max-width: 800px) {
      .row {
        grid-template-columns: 1fr;
      }
      .actions {
        justify-content: flex-start;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <h1>Dostupné akcie (verze 300)</h1>

    <div class="top">
      <label>Jméno obchodníka:</label>
      <input id="user" placeholder="např. Petr" />
    </div>

    <div id="debug" class="debug muted">HTML OK</div>
    <div id="list" class="muted">Načítám…</div>
  </div>

<script defer>
document.addEventListener("DOMContentLoaded", () => {

  const MIN_CENA = 1000000;

  const debug = (txt) => {
    document.getElementById("debug").textContent = txt;
    console.log(txt);
  };

  const supabase = window.supabase.createClient(
    "https://pureguxhuoskbrtavwkp.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1cmVndXhodW9za2JydGF2d2twIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODQzNjMsImV4cCI6MjA4NTk2MDM2M30.tc7zqlnGdlwooGFDaMOjGxTsl9RDVbQakeL_qajUlWc"
  );

  const jmeno = () => document.getElementById("user").value.trim();

  const formatCena = (c) =>
    new Intl.NumberFormat("cs-CZ").format(c) + " Kč";

  function vykresli(data) {
    const el = document.getElementById("list");

    const dostupne = data
      .filter(r => r.status === "K prodeji")
      .sort((a,b) => (a.priority_number ?? 0) - (b.priority_number ?? 0));

    if (dostupne.length === 0) {
      el.textContent = "Žádné akcie k prodeji.";
      return;
    }

    el.innerHTML = `<div class="muted">K prodeji: ${dostupne.length}</div>`;

    dostupne.forEach(r => {
      el.innerHTML += `
        <div class="row">
          <div><span class="badge">Priorita: <b>${r.priority_number}</b></span></div>

          <div>
            <div><b>Akcie #${r.id}</b></div>
            <div class="muted">Stav: ${r.status}</div>
          </div>

          <div><b>${formatCena(r.price)}</b></div>

          <div class="actions">
            <input
              type="number"
              min="${MIN_CENA}"
              step="1000"
              value="${r.price}"
              id="cena-${r.id}"
              style="width:140px"
            />
            <button class="primary" onclick="rezervovat(${r.id})">
              Rezervovat
            </button>
          </div>
        </div>
      `;
    });
  }

  async function nacist() {
    debug("Načítám data…");

    const { data, error } = await supabase
      .from("items")
      .select('id,priority_number,status,price,"reserved by","sold by"')
      .order("priority_number", { ascending: true });

    if (error) {
      debug("CHYBA: " + error.message);
      document.getElementById("list").textContent = error.message;
      return;
    }

    debug("Načteno řádků: " + data.length);
    vykresli(data);
  }

  async function rezervova
