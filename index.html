<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dostupné akcie</title>

  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin:0; background:#fff; }
    .wrap { max-width: 760px; margin: 60px auto; padding: 0 16px; text-align:center; }
    h1 { margin-bottom: 14px; }
    .top { display:flex; justify-content:center; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 280px; font-size: 14px; }
    .muted { color:#666; font-size:14px; }
    .debug { margin: 10px auto 14px; padding: 10px; border:1px solid #ddd; border-radius: 10px; text-align:left; max-width: 640px; background:#fafafa; }
    .row { border: 1px solid #ddd; border-radius: 10px; padding: 12px; margin: 12px 0; text-align: left; }
    .actions { margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background:#f7f7f7; }
    button.primary { background:#e8f3ff; }
    button.danger { background:#ffecec; }
    button:disabled { opacity:.5; cursor:not-allowed; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <h1>Dostupné akcie</h1>

    <div class="top">
      <label for="user">Jméno obchodníka:</label>
      <input id="user" placeholder="např. Petr" />
    </div>

    <div id="debug" class="debug muted">HTML OK</div>
    <div id="list" class="muted">Načítám…</div>
  </div>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const dbg = (msg) => {
        document.getElementById("debug").textContent = msg;
        console.log("[DBG]", msg);
      };

      dbg("1) JS start – DOM ready");

      if (!window.supabase) {
        dbg("STOP: Supabase knihovna se nenačetla");
        document.getElementById("list").textContent = "CHYBA: Supabase knihovna se nenačetla";
        return;
      }

      const supabase = window.supabase.createClient(
        "https://pureguxhuoskbrtavwkp.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1cmVndXhodW9za2JydGF2d2twIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODQzNjMsImV4cCI6MjA4NTk2MDM2M30.tc7zqlnGdlwooGFDaMOjGxTsl9RDVbQakeL_qajUlWc"
      );

      function getUser() {
        return document.getElementById("user").value.trim();
      }

      function render(items) {
        const el = document.getElementById("list");

        const visible = (items || []).filter(x => x.status !== "sold");

        if (visible.length === 0) {
          el.innerHTML = `<div class="muted">Žádné dostupné akcie</div>`;
          return;
        }

        el.innerHTML = `<div class="muted" style="margin-bottom:10px;">Načteno řádků: ${visible.length}</div>`;

        visible.forEach(i => {
          const who = i.reserved_by ? ` • rezervoval: <b>${i.reserved_by}</b>` : "";
          const canReserve = (i.status === "open");
          const canSell = (i.status !== "sold"); // později zpřísníme na "reserved by me"

          el.innerHTML += `
            <div class="row">
              <div><strong>${i.symbol}</strong> – ${i.name}</div>
              <div class="muted">stav: ${i.status}${who}</div>
              <div class="actions">
                <button class="primary" onclick="reserve(${i.id})" ${canReserve ? "" : "disabled"}>
                  Rezervovat
                </button>
                <button class="danger" onclick="sell(${i.id})" ${canSell ? "" : "disabled"}>
                  Prodáno
                </button>
              </div>
            </div>
          `;
        });
      }

      async function load() {
        dbg("2) SELECT start");
        document.getElementById("list").textContent = "Načítám…";

        const { data, error } = await supabase
          .from("items")
          .select("id,symbol,name,status,reserved_by")
          .order("id");

        if (error) {
          dbg("CHYBA SELECT: " + error.message);
          document.getElementById("list").textContent = "CHYBA (SELECT): " + error.message;
          return;
        }

        dbg("3) SELECT OK – řádků: " + data.length);
        render(data);
      }

      async function reserve(id) {
        const user = getUser();
        if (!user) return alert("Zadej jméno obchodníka");

        // DŮLEŽITÉ: zabrání duplicitě – uspěje jen když je status stále open
        const { error } = await supabase
          .from("items")
          .update({ status: "reserved", reserved_by: user })
          .eq("id", id)
          .eq("status", "open");

        if (error) {
          alert("CHYBA (reserve): " + error.message);
          return;
        }

        // Pokud už to někdo stihl před tebou, update nic neudělá -> jen refresh
        await load();
      }

      async function sell(id) {
        const user = getUser();
        if (!user) return alert("Zadej jméno obchodníka");

        // Základ: označí jako sold a zmizí z listu
        const { error } = await supabase
          .from("items")
          .update({ status: "sold" })
          .eq("id", id)
          .neq("status", "sold");

        if (error) {
          alert("CHYBA (sold): " + error.message);
          return;
        }

        await load();
      }

      // pro onclick v HTML
      window.reserve = reserve;
      window.sell = sell;

      load();
    });
  </script>
</body>
</html>
