<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Akcie – super evidence</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; background:#f7f7f8; }
    .card { background:#fff; border-radius:12px; padding:14px; box-shadow:0 1px 8px rgba(0,0,0,.06); margin-bottom:12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    label { display:block; font-size:12px; color:#444; margin-bottom:4px; }
    input, select, textarea { padding:10px; border:1px solid #ddd; border-radius:10px; min-width: 220px; }
    textarea { min-width: 320px; }
    button { padding:10px 12px; border:0; border-radius:10px; cursor:pointer; background:#111; color:#fff; }
    button.secondary { background:#eee; color:#111; }
    button.danger { background:#b00020; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .muted { color:#666; font-size: 12px; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#eee; }
    .grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1fr 1fr; } }
    .list { display:grid; grid-template-columns: 1fr; gap:10px; }
    .item-title { font-weight:700; }
    .status-AVAILABLE { background:#e8f5e9; }
    .status-RESERVED { background:#fff3e0; }
    .status-CONTRACT { background:#ede7f6; }
    .status-PAID { background:#e3f2fd; }
    .status-CANCELLED { background:#fce4ec; }
    .err { color:#b00020; font-size:12px; white-space:pre-wrap; }
    code { background:#f1f1f1; padding:2px 6px; border-radius:6px; }
    .checkbox { width:18px; height:18px; }
    .bulkbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .bulkleft { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  </style>
</head>
<body>

  <div class="card" id="loginCard">
    <h2>Přihlášení (jen super/admin)</h2>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" placeholder="super@firma.cz" autocomplete="username" />
      </div>
      <div>
        <label>Heslo</label>
        <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
      </div>
      <div style="display:flex; align-items:flex-end; gap:10px;">
        <button id="btnLogin">Přihlásit</button>
      </div>
    </div>
    <div class="muted">Project: <code>https://pruniywgvomfsghajxpt.supabase.co</code></div>
    <div class="err" id="loginMsg"></div>
  </div>

  <div class="card" id="appCard" style="display:none;">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <div>
        <div><b>Přihlášen:</b> <span id="who"></span> <span class="pill" id="rolePill"></span></div>
        <div class="muted">Super vyplňuje za všechny obchodníky. Obchodníci se nepřihlašují.</div>
      </div>
      <div class="row">
        <button class="secondary" id="btnRefresh">Obnovit</button>
        <button class="secondary" id="btnLogout">Odhlásit</button>
      </div>
    </div>
    <div class="err" id="appErr"></div>
  </div>

  <div class="grid" id="main" style="display:none;">
    <div class="card">
      <h3>Nový deal (rezervace)</h3>
      <div class="row">
        <div>
          <label>Akcie (AVAILABLE)</label>
          <select id="itemSelect"></select>
        </div>
        <div>
          <label>Obchodník – jméno</label>
          <input id="traderName" placeholder="Např. Novák" />
        </div>
        <div>
          <label>Obchodník – email</label>
          <input id="traderEmail" placeholder="obchodnik@firma.cz" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Klient – jméno</label>
          <input id="clientName" placeholder="Např. Jan Svoboda" />
        </div>
        <div>
          <label>Klient – email</label>
          <input id="clientEmail" placeholder="klient@email.cz" />
        </div>
        <div>
          <label>Klient – adresa</label>
          <input id="clientAddress" placeholder="Ulice, město" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Poznámka</label>
          <textarea id="notes" rows="3" placeholder="Poznámka k obchodu..."></textarea>
        </div>
      </div>

      <div class="row">
        <button id="btnReserve">Založit rezervaci</button>
        <button class="secondary" id="btnClear">Vyčistit</button>
      </div>

      <div class="err" id="formMsg"></div>
      <div class="muted">Tip: pro hromadnou rezervaci se použijí údaje z tohoto formuláře.</div>
    </div>

    <div class="card">
      <h3>Aktivní deal</h3>
      <div class="muted">V seznamu vpravo klikni na „Otevřít“ a pak můžeš měnit status.</div>
      <div id="activeDealBox" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="card" id="listCard" style="display:none;">
    <div class="bulkbar">
      <div class="bulkleft">
        <label style="display:flex; gap:8px; align-items:center; margin:0;">
          <input class="checkbox" type="checkbox" id="chkSelectAll">
          <span class="muted">Vybrat vše (aktuální filtr)</span>
        </label>

        <label style="margin:0;">
          <span class="muted">Filtr status</span><br/>
          <select id="statusFilter">
            <option value="">(vše)</option>
            <option>AVAILABLE</option>
            <option>RESERVED</option>
            <option>CONTRACT</option>
            <option>PAID</option>
          </select>
        </label>

        <label style="margin:0;">
          <span class="muted">Hledat</span><br/>
          <input id="q" placeholder="číslo / klient / obchodník..." />
        </label>
      </div>

      <div class="bulkleft">
        <span class="muted">Vybráno: <b id="selCount">0</b></span>
        <button id="btnBulkReserve">Hromadně zarezervovat</button>
        <button id="btnBulkContract">Hromadně smlouva</button>
        <button id="btnBulkPaid">Hromadně zaplaceno</button>
      </div>
    </div>

    <div class="err" id="bulkMsg" style="margin-top:10px;"></div>
    <hr style="border:none;border-top:1px solid #eee; margin:12px 0;">

    <div class="list" id="itemsList"></div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";

    const SUPABASE_URL = "https://pruniywgvomfsghajxpt.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBydW5peXdndm9tZnNnaGFqeHB0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzODAzMzAsImV4cCI6MjA4Njk1NjMzMH0.PU1rb1BQ9a_YUNyeq8up4PKTEd5hme_zPNHwc1rkjHY";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== STATE =====
    let activeDeal = null;
    let items = [];
    let dealsByItemId = new Map();
    let selectedItemIds = new Set();
    let lastRenderedItemIds = [];

    // ===== UI helpers =====
    const el = (id) => document.getElementById(id);
    const setErr = (id, msg) => { el(id).textContent = msg || ""; };
    const escapeHtml = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");

    const pad3 = (n) => String(n ?? "").padStart(3, "0");

    function itemLabel(it) {
      // Nové pojmenování: "AKCIE Č. 001"
      const num = (it.priority_number != null) ? it.priority_number : null;
      if (num != null) return `AKCIE Č. ${pad3(num)}`;
      // fallback: vytáhnout číslo ze symbolu typu AKC001
      const m = String(it.symbol || "").match(/(\d+)$/);
      return `AKCIE Č. ${pad3(m ? m[1] : "")}`;
    }

    function showLogin() {
      el("loginCard").style.display = "";
      el("appCard").style.display = "none";
      el("main").style.display = "none";
      el("listCard").style.display = "none";
      setErr("loginMsg", "");
      setErr("appErr", "");
      resetActive();
    }

    async function showApp() {
      el("loginCard").style.display = "none";
      el("appCard").style.display = "";
      el("main").style.display = "";
      el("listCard").style.display = "";
      setErr("appErr", "");

      const { data: u } = await supabase.auth.getUser();
      const user = u?.user;
      if (!user) return showLogin();

      try {
        const { data: prof, error } = await supabase
          .from("profiles")
          .select("role, full_name")
          .eq("user_id", user.id)
          .single();
        if (error) throw error;

        el("who").textContent = prof.full_name || user.email;
        el("rolePill").textContent = prof.role;

        await loadAll();
        resetActive();
      } catch (e) {
        setErr("appErr",
          "Chyba profilu/role. Vlož do public.profiles řádek pro svůj User ID (UUID) s rolí super/admin.\n\n" +
          (e?.message || String(e))
        );
      }
    }

    function resetActive() {
      activeDeal = null;
      el("activeDealBox").innerHTML = "<div class='muted'>Žádný deal nevybrán.</div>";
    }

    function updateSelCount() {
      el("selCount").textContent = String(selectedItemIds.size);
    }

    function fillItemsSelect() {
      const sel = el("itemSelect");
      const available = items.filter(x => x.status === "AVAILABLE");
      sel.innerHTML = available.map(x =>
        `<option value="${x.id}">${escapeHtml(itemLabel(x))}</option>`
      ).join("");
      if (!sel.value && available.length) sel.value = String(available[0].id);
    }

    function renderActiveDeal() {
      if (!activeDeal) return resetActive();
      const d = activeDeal;
      const item = d.item;
      const status = d.status;

      // Nové pořadí: RESERVED -> CONTRACT -> PAID
      const canContract = status === "RESERVED";
      const canPaid = status === "CONTRACT";

      el("activeDealBox").innerHTML = `
        <div class="card" style="margin:0;">
          <div class="row" style="justify-content:space-between; align-items:center;">
            <div>
              <div class="item-title">${escapeHtml(itemLabel(item))}</div>
              <div class="muted">Deal #${d.id} • status: <span class="pill status-${status}">${status}</span></div>
            </div>
            <button class="secondary" id="btnCloseDeal">Zavřít</button>
          </div>
          <hr style="border:none;border-top:1px solid #eee; margin:12px 0;">
          <div><b>Obchodník:</b> ${escapeHtml(d.trader_name)} ${d.trader_email ? `(<span class="muted">${escapeHtml(d.trader_email)}</span>)` : ""}</div>
          <div><b>Klient:</b> ${escapeHtml(d.client_name)} ${d.client_email ? `(<span class="muted">${escapeHtml(d.client_email)}</span>)` : ""}</div>
          ${d.client_address ? `<div><b>Adresa:</b> ${escapeHtml(d.client_address)}</div>` : ""}
          ${d.notes ? `<div><b>Pozn.:</b> ${escapeHtml(d.notes)}</div>` : ""}

          <div class="row" style="margin-top:12px;">
            <button id="btnMarkContract" ${!canContract ? "disabled" : ""}>Potvrdit smlouvu</button>
            <button id="btnMarkPaid" ${!canPaid ? "disabled" : ""}>Potvrdit platbu</button>
            <button class="danger" id="btnCancel" ${status==="PAID" ? "disabled" : ""}>Storno</button>
          </div>
          <div class="err" id="activeMsg" style="margin-top:8px;"></div>
        </div>
      `;

      el("btnCloseDeal").onclick = () => resetActive();
      el("btnMarkContract").onclick = async () => { await setDealStatus(d.id, "CONTRACT"); };
      el("btnMarkPaid").onclick = async () => { await setDealStatus(d.id, "PAID"); };
      el("btnCancel").onclick = async () => { await cancelDeal(d.id); };
    }

    function currentFilteredItems() {
      const statusF = el("statusFilter").value;
      const q = (el("q").value || "").trim().toLowerCase();

      return items.filter(it => {
        if (statusF && it.status !== statusF) return false;
        if (!q) return true;

        const d = dealsByItemId.get(it.id);
        const hay = [
          itemLabel(it),
          String(it.priority_number ?? ""),
          d?.trader_name, d?.client_name, d?.client_email
        ].filter(Boolean).join(" ").toLowerCase();

        return hay.includes(q);
      });
    }

    function renderList() {
      const filtered = currentFilteredItems();
      lastRenderedItemIds = filtered.map(x => x.id);

      // "Select all" reflects current filter: checked if all visible are selected (and there is at least one)
      const allVisibleSelected = filtered.length > 0 && filtered.every(it => selectedItemIds.has(it.id));
      el("chkSelectAll").checked = allVisibleSelected;

      el("itemsList").innerHTML = filtered.map(it => {
        const d = dealsByItemId.get(it.id);
        const pill = `<span class="pill status-${it.status}">${it.status}</span>`;
        const line2 = d
          ? `<div class="muted">${escapeHtml(d.trader_name)} → ${escapeHtml(d.client_name)} • Deal #${d.id}</div>`
          : `<div class="muted">Bez dealu</div>`;

        const btn = d
          ? `<button class="secondary" data-open="${d.id}">Otevřít</button>`
          : (it.status === "AVAILABLE" ? `<span class="muted">—</span>` : `<span class="muted">—</span>`);

        const checked = selectedItemIds.has(it.id) ? "checked" : "";

        return `
          <div class="card" style="margin:0;">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <div class="row" style="align-items:flex-start;">
                <input class="checkbox" type="checkbox" data-chk="${it.id}" ${checked}>
                <div>
                  <div class="item-title">${escapeHtml(itemLabel(it))} ${pill}</div>
                  ${line2}
                </div>
              </div>
              <div>${btn}</div>
            </div>
          </div>
        `;
      }).join("");

      document.querySelectorAll("[data-open]").forEach(btn => {
        btn.addEventListener("click", () => openDeal(Number(btn.getAttribute("data-open"))));
      });

      document.querySelectorAll("[data-chk]").forEach(chk => {
        chk.addEventListener("change", (e) => {
          const id = Number(chk.getAttribute("data-chk"));
          if (chk.checked) selectedItemIds.add(id);
          else selectedItemIds.delete(id);
          updateSelCount();
          // update select-all state
          const filteredNow = currentFilteredItems();
          el("chkSelectAll").checked = filteredNow.length > 0 && filteredNow.every(it => selectedItemIds.has(it.id));
        });
      });

      updateSelCount();
    }

    async function loadAll() {
      setErr("formMsg", "");
      setErr("appErr", "");
      setErr("bulkMsg", "");

      const { data: itemsData, error: itErr } = await supabase
        .from("items")
        .select("id,symbol,company,priority_number,status,updated_at")
        .order("priority_number", { ascending: true, nullsFirst: false })
        .order("id", { ascending: true });

      if (itErr) throw itErr;
      items = itemsData || [];

      const { data: dealsData, error: dErr } = await supabase
        .from("deals")
        .select("id,item_id,trader_name,trader_email,client_name,client_email,client_address,notes,status,paid_at,contract_at,created_at,updated_at")
        .in("status", ["RESERVED","CONTRACT","PAID"]);

      if (dErr) throw dErr;

      dealsByItemId = new Map();
      (dealsData || []).forEach(d => {
        const prev = dealsByItemId.get(d.item_id);
        if (!prev || new Date(d.updated_at) > new Date(prev.updated_at)) {
          dealsByItemId.set(d.item_id, d);
        }
      });

      // prune selections that no longer exist
      const idSet = new Set(items.map(x => x.id));
      selectedItemIds = new Set([...selectedItemIds].filter(id => idSet.has(id)));

      fillItemsSelect();
      renderList();
    }

    async function reserveDeal(itemIdOverride=null) {
      setErr("formMsg", "");
      const itemId = Number(itemIdOverride ?? el("itemSelect").value);
      const traderName = el("traderName").value.trim();
      const traderEmail = el("traderEmail").value.trim();
      const clientName = el("clientName").value.trim();
      const clientEmail = el("clientEmail").value.trim();
      const clientAddress = el("clientAddress").value.trim();
      const notes = el("notes").value.trim();

      if (!itemId) throw new Error("Vyber akcii.");
      if (!traderName) throw new Error("Vyplň jméno obchodníka.");
      if (!clientName) throw new Error("Vyplň jméno klienta.");

      const { data: u } = await supabase.auth.getUser();
      const createdBy = u?.user?.id;
      if (!createdBy) throw new Error("Nejsi přihlášen.");

      const { data: deal, error: insErr } = await supabase.from("deals")
        .insert([{
          item_id: itemId,
          trader_name: traderName,
          trader_email: traderEmail || null,
          client_name: clientName,
          client_email: clientEmail || null,
          client_address: clientAddress || null,
          notes: notes || null,
          status: "RESERVED",
          created_by: createdBy
        }])
        .select("id,item_id,status,updated_at")
        .single();

      if (insErr) throw insErr;

      const { error: upErr } = await supabase.from("items")
        .update({ status: "RESERVED" })
        .eq("id", itemId)
        .eq("status", "AVAILABLE");

      if (upErr) throw upErr;

      return deal;
    }

    async function openDeal(dealId) {
      const { data: deal, error } = await supabase.from("deals")
        .select("id,item_id,trader_name,trader_email,client_name,client_email,client_address,notes,status,paid_at,contract_at,updated_at")
        .eq("id", dealId)
        .single();
      if (error) throw error;

      const item = items.find(x => x.id === deal.item_id);
      activeDeal = { ...deal, item };
      renderActiveDeal();
    }

    async function setDealStatus(dealId, next) {
      setErr("activeMsg", "");
      // new order: RESERVED -> CONTRACT -> PAID
      const patch = { status: next };
      if (next === "PAID") patch.paid_at = new Date().toISOString();
      if (next === "CONTRACT") patch.contract_at = new Date().toISOString();

      const { error: dErr } = await supabase.from("deals")
        .update(patch)
        .eq("id", dealId);

      if (dErr) return setErr("activeMsg", dErr.message || String(dErr));

      // keep item status aligned
      const itemId = activeDeal.item.id;
      const { error: iErr } = await supabase.from("items")
        .update({ status: next })
        .eq("id", itemId);

      if (iErr) return setErr("activeMsg", iErr.message || String(iErr));

      await loadAll();
      await openDeal(dealId);
      setErr("activeMsg", "Uloženo.");
    }

    async function cancelDeal(dealId) {
      setErr("activeMsg", "");
      const itemId = activeDeal.item.id;

      const { error: dErr } = await supabase.from("deals")
        .update({ status: "CANCELLED" })
        .eq("id", dealId);

      if (dErr) return setErr("activeMsg", dErr.message || String(dErr));

      const { error: iErr } = await supabase.from("items")
        .update({ status: "AVAILABLE" })
        .eq("id", itemId);

      if (iErr) return setErr("activeMsg", iErr.message || String(iErr));

      await loadAll();
      resetActive();
    }

    // ===== BULK OPS =====
    async function bulkReserve() {
      setErr("bulkMsg", "");
      const selected = [...selectedItemIds];
      if (selected.length === 0) return setErr("bulkMsg", "Nic není vybráno.");

      // validate form once
      const traderName = el("traderName").value.trim();
      const clientName = el("clientName").value.trim();
      if (!traderName) return setErr("bulkMsg", "Pro hromadnou rezervaci vyplň jméno obchodníka (vlevo).");
      if (!clientName) return setErr("bulkMsg", "Pro hromadnou rezervaci vyplň jméno klienta (vlevo).");

      let ok = 0, skipped = 0;
      const reasons = [];
      for (const itemId of selected) {
        const it = items.find(x => x.id === itemId);
        if (!it) { skipped++; reasons.push(`${itemId}: neexistuje`); continue; }
        if (it.status !== "AVAILABLE") { skipped++; reasons.push(`${itemLabel(it)}: není AVAILABLE`); continue; }
        try {
          await reserveDeal(itemId);
          ok++;
        } catch (e) {
          skipped++;
          reasons.push(`${itemLabel(it)}: ${e?.message || e}`);
        }
      }
      await loadAll();
      setErr("bulkMsg", `Hotovo. OK: ${ok}, přeskočeno: ${skipped}` + (reasons.length ? "\n" + reasons.slice(0, 30).join("\n") : ""));
    }

    async function bulkStatus(next) {
      setErr("bulkMsg", "");
      const selected = [...selectedItemIds];
      if (selected.length === 0) return setErr("bulkMsg", "Nic není vybráno.");

      let ok = 0, skipped = 0;
      const reasons = [];

      for (const itemId of selected) {
        const it = items.find(x => x.id === itemId);
        const d = dealsByItemId.get(itemId);
        if (!it) { skipped++; reasons.push(`${itemId}: neexistuje`); continue; }
        if (!d) { skipped++; reasons.push(`${itemLabel(it)}: nemá deal`); continue; }

        // eligibility based on new order
        const needStatus = (next === "CONTRACT") ? "RESERVED" : "CONTRACT";
        if (d.status !== needStatus) {
          skipped++;
          reasons.push(`${itemLabel(it)}: deal není ve stavu ${needStatus}`);
          continue;
        }

        try {
          const patch = { status: next };
          if (next === "PAID") patch.paid_at = new Date().toISOString();
          if (next === "CONTRACT") patch.contract_at = new Date().toISOString();

          const { error: dErr } = await supabase.from("deals").update(patch).eq("id", d.id);
          if (dErr) throw dErr;

          const { error: iErr } = await supabase.from("items").update({ status: next }).eq("id", itemId);
          if (iErr) throw iErr;

          ok++;
        } catch (e) {
          skipped++;
          reasons.push(`${itemLabel(it)}: ${e?.message || e}`);
        }
      }

      await loadAll();
      const label = (next === "CONTRACT") ? "smlouva" : "zaplaceno";
      setErr("bulkMsg", `Hromadně ${label}. OK: ${ok}, přeskočeno: ${skipped}` + (reasons.length ? "\n" + reasons.slice(0, 30).join("\n") : ""));
    }

    // ===== EVENTS =====
    el("btnLogin").addEventListener("click", async () => {
      try {
        setErr("loginMsg", "");
        const email = el("email").value.trim();
        const password = el("password").value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        await showApp();
      } catch (e) {
        setErr("loginMsg", e?.message || String(e));
      }
    });

    el("btnLogout").addEventListener("click", async () => {
      await supabase.auth.signOut();
      showLogin();
    });

    el("btnRefresh").addEventListener("click", async () => {
      try { await loadAll(); } catch (e) { setErr("appErr", e?.message || String(e)); }
    });

    el("btnReserve").addEventListener("click", async () => {
      try {
        const deal = await reserveDeal(null);
        await loadAll();
        await openDeal(deal.id);
        setErr("formMsg", "Rezervace vytvořena.");
      } catch (e) {
        setErr("formMsg", e?.message || String(e));
      }
    });

    el("btnClear").addEventListener("click", () => {
      el("traderName").value = "";
      el("traderEmail").value = "";
      el("clientName").value = "";
      el("clientEmail").value = "";
      el("clientAddress").value = "";
      el("notes").value = "";
      setErr("formMsg", "");
    });

    el("statusFilter").addEventListener("change", renderList);
    el("q").addEventListener("input", renderList);

    el("chkSelectAll").addEventListener("change", () => {
      const filtered = currentFilteredItems();
      if (el("chkSelectAll").checked) {
        filtered.forEach(it => selectedItemIds.add(it.id));
      } else {
        filtered.forEach(it => selectedItemIds.delete(it.id));
      }
      updateSelCount();
      renderList();
    });

    el("btnBulkReserve").addEventListener("click", bulkReserve);
    el("btnBulkContract").addEventListener("click", () => bulkStatus("CONTRACT"));
    el("btnBulkPaid").addEventListener("click", () => bulkStatus("PAID"));

    // ===== INIT =====
    (async () => {
      const { data: s } = await supabase.auth.getSession();
      if (s?.session) await showApp();
      else showLogin();
    })();
  </script>
</body>
</html>
