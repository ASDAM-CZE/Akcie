<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dostupné akcie</title>

  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin:0; background:#fff; }
    .wrap { max-width: 960px; margin: 60px auto; padding: 0 16px; text-align:center; }
    h1 { margin-bottom: 14px; }

    .top { display:flex; justify-content:center; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 280px; font-size: 14px; }

    .muted { color:#666; font-size:14px; }
    .debug { margin: 10px auto 14px; padding: 10px; border:1px solid #ddd; border-radius: 10px; text-align:left; max-width: 900px; background:#fafafa; }

    .row{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin: 12px 0;
      text-align: left;

      display:grid;
      grid-template-columns: 160px 1fr 160px 280px;
      gap: 10px;
      align-items:center;
    }

    .badge {
      display:inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ddd;
      font-size: 12px;
    }

    .actions { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor:pointer; background:#f7f7f7; }
    button.primary { background:#e8f3ff; }
    button.danger { background:#ffecec; }
    button:disabled { opacity:.5; cursor:not-allowed; }

    @media (max-width: 760px){
      .row { grid-template-columns: 1fr; }
      .actions { justify-content:flex-start; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap">
    <h1>Dostupné akcie (verze 200)</h1>

    <div class="top">
      <label for="user">Jméno obchodníka:</label>
      <input id="user" placeholder="např. Petr" />
    </div>

    <div id="debug" class="debug muted">HTML OK</div>
    <div id="list" class="muted">Načítám…</div>
  </div>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const dbg = (msg) => {
        document.getElementById("debug").textContent = msg;
        console.log("[INFO]", msg);
      };

      if (!window.supabase) {
        dbg("Chyba: nepodařilo se načíst knihovnu Supabase (síť / blokace CDN).");
        document.getElementById("list").textContent = "Chyba: Supabase se nenačetlo.";
        return;
      }

      const supabase = window.supabase.createClient(
        "https://pureguxhuoskbrtavwkp.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1cmVndXhodW9za2JydGF2d2twIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODQzNjMsImV4cCI6MjA4NTk2MDM2M30.tc7zqlnGdlwooGFDaMOjGxTsl9RDVbQakeL_qajUlWc"
      );

      function jmeno() {
        return document.getElementById("user").value.trim();
      }

      function cenaFmt(x) {
        if (x === null || x === undefined || x === "") return "";
        const n = Number(x);
        if (Number.isNaN(n)) return String(x);
        return new Intl.NumberFormat("cs-CZ").format(n) + " Kč";
      }

      function vykresli(radky) {
        const el = document.getElementById("list");

        // ukazujeme JEN "K prodeji"
        const dostupne = (radky || []).filter(r => r.status === "K prodeji");

        if (dostupne.length === 0) {
          el.textContent = "Žádné akcie k prodeji.";
          return;
        }

        // řazení podle priority_number
        dostupne.sort((a,b) => Number(a.priority_number ?? 0) - Number(b.priority_number ?? 0));

        el.innerHTML = `<div class="muted" style="margin-bottom:10px;">K prodeji: ${dostupne.length}</div>`;

        dostupne.forEach(r => {
          el.innerHTML += `
            <div class="row">
              <div><span class="badge">Priorita: <b>${r.priority_number ?? ""}</b></span></div>

              <div>
                <div><b>Akcie #${r.id}</b></div>
                <div class="muted">Stav: ${r.status}</div>
              </div>

              <div><b>${cenaFmt(r.price)}</b></div>

              <div class="actions">
                <button class="primary" onclick="rezervovat(${r.id})">Rezervovat</button>
              </div>
            </div>
          `;
        });
      }

      async function nacist() {
        dbg("Načítám data z databáze…");
        document.getElementById("list").textContent = "Načítám…";

        // DŮLEŽITÉ: sloupce s mezerou musí být v uvozovkách
        const { data, error } = await supabase
          .from("items")
          .select('id,priority_number,status,price,"reserved by","sold by"')
          .order("priority_number", { ascending: true });

        if (error) {
          dbg("CHYBA (SELECT): " + error.message);
          document.getElementById("list").textContent = "CHYBA (SELECT): " + error.message;
          return;
        }

        dbg("Načteno řádků: " + (data ? data.length : 0));
        vykresli(data || []);
      }

      async function rezervovat(id) {
        const u = jmeno();
        if (!u) return alert("Zadej jméno obchodníka");

        // ochrana proti dvojité rezervaci:
        // projde jen pokud je status stále "K prodeji"
        const { error } = await supabase
          .from("items")
          .update({ status: "Rezervována", "reserved by": u })
          .eq("id", id)
          .eq("status", "K prodeji");

        if (error) return alert("CHYBA (rezervace): " + error.message);

        await nacist();
      }

      // kdyby ses rozhodl přidat tlačítko prodáno později:
      async function prodat(id) {
        const u = jmeno();
        if (!u) return alert("Zadej jméno obchodníka");

        // bezpečný prodej: jen když je rezervována A rezervoval ji ten samý člověk
        const { error } = await supabase
          .from("items")
          .update({ status: "Nedostupná", "sold by": u })
          .eq("id", id)
          .eq("status", "Rezervována")
          .eq("reserved by", u);

        if (error) return alert("CHYBA (prodej): " + error.message);

        await nacist();
      }

      // pro onclick
      window.rezervovat = rezervovat;
      window.prodat = prodat;

      nacist();
    });
  </script>
</body>
</html>

