<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Rezervační systém</title>
<style>
:root{
  --text: #000000;
  --muted: #7a7a7a;
  --section-bg: #fbfdff;
  --section-gap: 18px;
  --brand-size: 2.4em;
  --section-padding: 18px;
}

/* Reset / základ */
body { font-family: Arial, sans-serif; padding: 28px; color: var(--text); background:#fff; }
.hidden { display: none; }

/* VĚTŠÍ CHECKBOXY */
input[type="checkbox"] {
  width: 22px;
  height: 22px;
  cursor: pointer;
}

/* Brand a nadpisy */
.brand {
  text-align: center;
  font-size: var(--brand-size);
  font-weight: 800;
  letter-spacing: .5px;
  margin: 18px 0 6px;
  color: var(--text);
  line-height: 1.05;
  display:block;
}

/* Podnadpis pod názvem */
.brand-sub {
  text-align:center;
  font-size: 1.05em;
  font-weight:700;
  color: var(--text);
  margin-bottom: 12px;
  opacity: 0.98;
}

/* Přihlašovací box */
#login-section {
  max-width: 520px;
  margin: 60px auto;
  padding: 28px;
  border: 1px solid #e6e6e6;
  border-radius: 12px;
  background: #fff;
  font-size: 1.05em;
  box-shadow: 0 6px 18px rgba(0,0,0,0.03);
}

/* Přihlašovací popisek */
.login-subtitle {
  color: var(--text);
  font-weight:700;
  margin-bottom: 10px;
  font-size: 1.05em;
}

/* Form inputs */
#login-section input {
  width: 100%;
  padding: 12px;
  font-size: 1.05em;
  margin-bottom: 14px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 8px;
}

#login-btn {
  width: 100%;
  padding: 14px;
  font-size: 1.15em;
  background: #007bff;
  color: white;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}

#login-btn:hover { background: #005fcc; }

.error { color: red; }

/* Kontejner aplikace */
#app-section { max-width: 980px; margin: 18px auto; padding: 0 8px; }

/* Sekce a mezery */
.section {
  background: var(--section-bg);
  padding: var(--section-padding);
  margin-bottom: var(--section-gap);
  border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.03);
  border: 1px solid #eef3f8;
}

/* Řádek položky */
.row { border: 1px solid #e2e8f0; padding: 12px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; gap:12px; border-radius:8px; background: #fff; }

/* Tlumené / subtle */
.subtle { color: var(--muted); opacity: 0.95; border-color: #e9eef3; background: #fbfcfd; }

/* Dostupné zvýraznění */
.available { background: #f5fbff; border: 1px solid #dbeafe; }

/* Badge a text */
.badge { background: #ddd; padding: 3px 6px; border-radius: 4px; font-weight:700; }
.muted { color: var(--muted); font-size: 0.9em; }
.muted.prio { margin-left: 8px; font-size:0.9em; color:#444; font-weight:600; }

/* Akční tlačítka */
.actions button { margin-left: 5px; font-size: 1.05em; padding: 8px 14px; border: none; cursor: pointer; border-radius:6px; }

.primary { background: #007bff; color: white; border: none; padding: 6px 10px; cursor: pointer; }
.sell-btn { background: #22c55e; color: #fff; }
.paid-btn { background: #facc15; color: #111; }
.cancel-btn { background: #ff0033; color: #fff; }

/* Zvýrazněné hlavní tlačítko - větší */
#bulk-reserve {
  font-size: 1.25em;
  padding: 12px 22px;
  min-width: 220px;
  border-radius: 10px;
  box-shadow: 0 6px 14px rgba(3, 102, 214, 0.12);
}
#bulk-reserve:disabled { opacity: 0.55; cursor: not-allowed; }

/* Accordion */
.accordion { margin-top: 10px; }
.acc-header {
  background: transparent;
  padding: 8px 10px;
  cursor: pointer;
  border: none;
  margin-top: 6px;
  font-size: 1.05em;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
}
.acc-header .title { font-weight:700; color: var(--text); }
.acc-body { padding: 8px 0; }
.acc-body.hidden { display: none; }

/* Group toggle button */
.group-toggle {
  background: transparent;
  border: none;
  font-size: 1.05em;
  cursor: pointer;
  width:36px;
  height:36px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:6px;
}
.group-toggle[aria-expanded="false"] { color: var(--muted); }
.group-toggle[aria-expanded="true"] { color: #111; }

/* Hromadná tlačítka */
.bulk-actions { margin: 10px 0; }
.bulk-actions button { margin-right: 8px; font-size:1.05em; padding:8px 12px; border-radius:6px; }

/* Available header */
.available-header { display:flex; justify-content:space-between; align-items:center; margin:6px 0 10px; }
.available-actions { display:flex; gap:8px; }

/* Hlavičky sladěné barvy podle sekce (obnovené původní barvy) */
.acc-header[data-target="rez"] { background:#dbeafe; border-color:#3b82f6; color:#0b5ed7; border-radius:8px; padding:10px; }
.acc-header[data-target="pro"] { background:#dcfce7; border-color:#22c55e; color:#166534; border-radius:8px; padding:10px; }
.acc-header[data-target="zap"] { background:#fef9c3; border-color:#facc15; color:#92400e; border-radius:8px; padding:10px; }

/* Modal */
.modal.hidden { display: none; }
.modal { position: fixed; inset: 0; z-index: 9999; }
.modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.4); }
.modal-card { position: relative; max-width: 520px; margin: 8vh auto; background: #fff; border-radius: 12px; border: 1px solid #ddd; padding: 20px 20px 16px; box-shadow: 0 12px 32px rgba(0,0,0,0.2); }

@media (max-width:800px){
  .row { flex-direction: column; align-items:flex-start; gap:8px; }
  .row .actions { align-self:stretch; display:flex; gap:8px; justify-content:flex-end; width:100%; }
}
</style>
</head>
<body>

<!-- Brand -->
<h1 class="brand">Rezidence Chrudim I</h1>
<div class="brand-sub">Prioritní akcie</div>

<!-- LOGIN -->
<div id="login-section" class="section">
  <div class="login-subtitle">Přihlášení do uživatelského účtu</div>
  <h2 style="margin:6px 0 12px; font-size:1.15em; color:var(--text);">Přihlášení</h2>
  <div>
    <label>Jméno:</label><br>
    <input id="login-name" type="text">
  </div>
  <div>
    <label>Heslo:</label><br>
    <input id="login-password" type="password">
  </div>
  <button id="login-btn">Přihlásit</button>
  <div id="login-msg" class="error"></div>
</div>

<!-- APP -->
<div id="app-section" class="hidden">
  <h2>Vítejte, <span id="user-label"></span></h2>
  <button id="logout-btn">Odhlásit</button>
  <div id="list" style="margin-top:12px;"></div>
</div>

<div id="debug" style="margin-top:20px; color:#888;"></div>

<!-- MODAL: Hromadná rezervace -->
<div id="bulkReserveModal" class="modal hidden" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="brm-title">
  <div class="modal-backdrop" id="brm-backdrop"></div>
  <div class="modal-card" role="document">
    <h3 id="brm-title">Hromadná rezervace</h3>
    <span class="muted">Počet vybraných položek: <b id="brm-count">0</b></span>

    <label for="brm-customer">Jméno zákazníka</label>
    <input id="brm-customer" type="text" placeholder="Zadejte jméno zákazníka" />

    <label for="brm-price">Společná cena</label>
    <input id="brm-price" type="number" min="1000000" step="1000" inputmode="numeric" placeholder="1 000 000 Kč — za jednu akcii" />
    <small class="muted">Tato cena se použije pro všechny vybrané položky (Kč — za jednu akcii).</small>

    <div id="brm-msg" class="error" style="min-height:1.2em; margin-top:6px;"></div>

    <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:8px; margin-top:14px;">
      <button id="brm-cancel" class="cancel-btn" type="button">Zrušit</button>
      <button id="brm-submit" class="primary" type="button">Potvrdit rezervaci</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const debugEl = document.getElementById("debug");
  const listEl = document.getElementById("list");
  const loginSection = document.getElementById("login-section");
  const appSection = document.getElementById("app-section");
  const loginNameInput = document.getElementById("login-name");
  const loginPasswordInput = document.getElementById("login-password");
  const loginBtn = document.getElementById("login-btn");
  const loginMsg = document.getElementById("login-msg");
  const userLabel = document.getElementById("user-label");
  const logoutBtn = document.getElementById("logout-btn");

  // Modal prvky
  const brmEl = document.getElementById("bulkReserveModal");
  const brmCountEl = document.getElementById("brm-count");
  const brmCustomerEl = document.getElementById("brm-customer");
  const brmPriceEl = document.getElementById("brm-price");
  const brmMsgEl = document.getElementById("brm-msg");
  const brmCancelBtn = document.getElementById("brm-cancel");
  const brmSubmitBtn = document.getElementById("brm-submit");
  const brmBackdrop = document.getElementById("brm-backdrop");

  let currentTraderId = null;
  let currentTraderName = null;
  let currentIsAdmin = false;

  const debug = (txt) => { if (!debugEl) return; debugEl.textContent = txt; console.log(txt); };

  const supabase = window.supabase.createClient(
    "https://pureguxhuoskbrtavwkp.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1cmVndXhodW9za2JydGF2d2twIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzODQzNjMsImV4cCI6MjA4NTk2MDM2M30.tc7zqlnGdlwooGFDaMOjGxTsl9RDVbQakeL_qajUlWc"
  );

  const formatCena = (c) => new Intl.NumberFormat("cs-CZ").format(c) + " Kč";

  function showLogin() {
    loginSection.classList.remove("hidden");
    appSection.classList.add("hidden");
    currentTraderId = null;
    currentTraderName = null;
    currentIsAdmin = false;
    loginPasswordInput.value = "";
  }

  function showApp() {
    loginSection.classList.add("hidden");
    appSection.classList.remove("hidden");
  }

  async function handleLogin() {
    const name = loginNameInput.value.trim();
    const password = loginPasswordInput.value.trim();
    loginMsg.textContent = "";
    loginMsg.classList.remove("error");

    if (!name || !password) {
      loginMsg.textContent = "Vyplňte prosím jméno i heslo.";
      loginMsg.classList.add("error");
      return;
    }

    const { data, error } = await supabase
      .from("traders")
      .select("id, is_admin")
      .eq("password", password)
      .eq("active", true)
      .limit(1)
      .maybeSingle();

    if (error) {
      loginMsg.textContent = "Chyba při přihlášení.";
      loginMsg.classList.add("error");
      debug("Login error: " + error.message);
      return;
    }

    if (!data) {
      loginMsg.textContent = "Neplatné heslo.";
      loginMsg.classList.add("error");
      return;
    }

    currentTraderId = data.id;
    currentTraderName = name;
    currentIsAdmin = data.is_admin === true;
    userLabel.textContent = currentTraderName;
    showApp();
    nacist();
  }

  async function zrusitStareRezervace() {
    const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
    await supabase
      .from("items")
      .update({
        status: "K prodeji",
        reserved_by: null,
        reserved_for: null,
        reserved_at: null,
        paid: false
      })
      .lt("reserved_at", cutoff)
      .eq("status", "Rezervováno");
  }

  async function nacist() {
    debug("Načítám data…");
    listEl.textContent = "Načítám…";

    await zrusitStareRezervace();

    const { data, error } = await supabase
      .from("items")
      .select("id,priority_number,status,price,reserved_by,reserved_for,reserved_at,paid")
      .order("priority_number", { ascending: true });

    if (error) {
      debug("Chyba při načítání items: " + error.message);
      listEl.textContent = "Chyba při načítání dat.";
      return;
    }

    if (!data || data.length === 0) {
      listEl.textContent = "Žádná data k zobrazení.";
      return;
    }

    const moje = currentIsAdmin ? data : data.filter(r => r.reserved_by === currentTraderName);
    vykresli(data, moje);
  }

  // --- upravená funkce: získat vybraná dostupná id (používá .bulk-available) ---
  function getSelectedAvailableIds() {
    const container = document.getElementById("available-list");
    if (!container) return [];
    return Array.from(container.querySelectorAll(".bulk-available:checked")).map(c => c.dataset.id);
  }

  function updateBulkReserveState() {
    const btn = document.getElementById("bulk-reserve");
    if (!btn) return;
    const count = getSelectedAvailableIds().length;
    btn.disabled = count === 0;
    btn.textContent = count > 0 ? `Hromadně rezervovat (${count})` : "Hromadně rezervovat";
  }

  // Vrací ID vybraných položek pro hromadné zrušení.
  // Pokud je currentIsAdmin true, sbírá vybrané checkboxy z Rezervované, Prodáno i Zaplaceno.
  // Jinak vrací pouze z Rezervované.
  function getSelectedIdsForBulkCancel() {
    if (currentIsAdmin) {
      const ids = new Set();
      ["#rez", "#pro", "#zap"].forEach(selector => {
        const root = document.querySelector(selector);
        if (!root) return;
        root.querySelectorAll(".bulk:checked").forEach(cb => ids.add(cb.dataset.id));
      });
      return Array.from(ids);
    } else {
      return getSelectedIds("#rez");
    }
  }

  function getSelectedIds(containerSelector) {
    const root = containerSelector ? document.querySelector(containerSelector) : document;
    if (!root) return [];
    return Array.from(root.querySelectorAll(".bulk:checked")).map(c => c.dataset.id);
  }

  function vykresli(data, moje) {
    let html = "";

    // Moje rezervace / Prodáno / Zaplaceno
    if (moje.length > 0) {
      let htmlRez = "";
      let htmlPro = "";
      let htmlZap = "";

      moje.forEach(r => {
        const subtleClass = (r.status === "Rezervováno" || r.status === "Prodáno") ? "subtle" : "";
        const trida =
          r.paid === true ? "zaplaceno" :
          r.status === "Prodáno" ? "prodano" :
          r.status === "Rezervováno" ? "rezervovano" : "";

        // checkbox: pokud je položka zaplacena a uživatel není admin, checkbox se nezobrazuje.
        // Admin uvidí checkbox i pro zaplacené položky, aby mohl provádět hromadné zrušení.
        const checkboxHtml = (r.paid === true && !currentIsAdmin)
          ? ""
          : `<input type="checkbox" class="bulk" data-id="${r.id}">`;

        // tlačítka podle stavu a práv admina
        let tlacitka = "";
        if (r.paid === true) {
          // zaplaceno: admin může zrušit (vrátit do K prodeji), běžný uživatel nic
          tlacitka = currentIsAdmin ? `<button data-id="${r.id}" class="cancel-btn">Zrušit rezervaci</button>` : "";
        } else if (r.status === "Prodáno") {
          // prodáno: běžný uživatel může označit jako zaplaceno, admin může i zrušit
          tlacitka = currentIsAdmin
            ? `<button data-id="${r.id}" class="paid-btn">Zaplatit</button><button data-id="${r.id}" class="cancel-btn">Zrušit rezervaci</button>`
            : `<button data-id="${r.id}" class="paid-btn">Zaplatit</button>`;
        } else if (r.status === "Rezervováno") {
          // rezervováno: oba mají standardní možnosti
          tlacitka = `
            <button data-id="${r.id}" class="sell-btn">Prodat</button>
            <button data-id="${r.id}" class="cancel-btn">Zrušit rezervaci</button>
          `;
        }

        const badgeWithText = `<span><span class="badge">#${r.id}</span><span class="muted prio">prioritní akcie</span></span>`;
        const blok = `
          <div class="row ${subtleClass} ${trida}">
            <div>
              ${checkboxHtml}
              ${badgeWithText}
            </div>
            <div>
              <span class="muted">Cena: ${formatCena(r.price || 0)}</span><br>
              <span class="muted">Zákazník: ${r.reserved_for || "-"}</span><br>
              <span class="muted">Rezervováno: ${r.reserved_at ? new Date(r.reserved_at).toLocaleString("cs-CZ") : "-"}</span><br>
              <span class="muted">Stav: ${r.status}</span>
            </div>
            <div class="actions">${tlacitka}</div>
          </div>
        `;

        if (r.paid === true) {
          htmlZap += blok;
        } else if (r.status === "Prodáno") {
          htmlPro += blok;
        } else {
          htmlRez += blok;
        }
      });

      html += `
        <div class="section">
          <h2>Moje rezervace (${moje.length})</h2>
          <div class="bulk-actions">
            <button id="bulk-sell" class="sell-btn">Hromadně prodat</button>
            <button id="bulk-paid" class="paid-btn">Hromadně zaplatit</button>
            <button id="bulk-cancel" class="cancel-btn">Hromadně zrušit</button>
          </div>
          <div class="accordion">
            <div class="acc-header" data-target="rez">
              <button class="group-toggle" aria-expanded="false">▸</button>
              <span class="title">Rezervované</span>
            </div>
            <div id="rez" class="acc-body hidden">${htmlRez || "<div class='muted'>Žádné rezervované položky.</div>"}</div>

            <div class="acc-header" data-target="pro">
              <button class="group-toggle" aria-expanded="false">▸</button>
              <span class="title">Prodáno</span>
            </div>
            <div id="pro" class="acc-body hidden">${htmlPro || "<div class='muted'>Žádné prodané položky.</div>"}</div>

            <div class="acc-header" data-target="zap">
              <button class="group-toggle" aria-expanded="false">▸</button>
              <span class="title">Zaplaceno</span>
            </div>
            <div id="zap" class="acc-body hidden">${htmlZap || "<div class='muted'>Žádné zaplacené položky.</div>"}</div>
          </div>
        </div>
      `;
    }

    // Dostupné akcie + hromadná rezervace
    const dostupne = data.filter(r => r.status === "K prodeji");
    html += `
      <div class="section">
        <h2>Dostupné akcie (${dostupne.length})</h2>
        <div class="available-header">
          <div class="muted">Vyber položky, pak je hromadně rezervuj k jednomu zákazníkovi.</div>
          <div class="available-actions">
            <button id="bulk-reserve" class="primary" disabled>Hromadně rezervovat</button>
          </div>
        </div>
    `;

    let htmlAvail = "";
    dostupne.forEach(r => {
      htmlAvail += `
        <div class="row available">
          <div>
            <!-- upravená třída checkboxu: bulk-available -->
            <input type="checkbox" class="bulk-available" data-id="${r.id}">
            <span class="badge">#${r.id}</span>
            <span class="muted prio">prioritní akcie</span>
          </div>
          <div>
            <div class="muted">Stav: ${r.status}</div>
          </div>
          <div><b>${formatCena(r.price || 0)}</b></div>
          <div class="actions">
            <input type="number" min="1000000" step="1000" value="${r.price || 1000000}" id="cena-${r.id}" style="width:140px" />
            <input type="text" placeholder="Jméno zákazníka" id="zakaznik-${r.id}" style="width:160px" />
            <button class="primary" data-id="${r.id}">Rezervovat</button>
          </div>
        </div>
      `;
    });

    html += `<div id="available-list">${htmlAvail || "<div class='muted'>Žádné dostupné položky.</div>"}</div></div>`;
    listEl.innerHTML = html;

    // Jednotlivé akce
    listEl.querySelectorAll(".sell-btn").forEach(btn => {
      btn.addEventListener("click", (e) => { e.preventDefault(); oznacitProdej(btn.dataset.id); });
    });

    listEl.querySelectorAll(".paid-btn").forEach(btn => {
      btn.addEventListener("click", (e) => { e.preventDefault(); oznacitZaplaceno(btn.dataset.id); });
    });

    listEl.querySelectorAll(".cancel-btn").forEach(btn => {
      btn.addEventListener("click", (e) => { e.preventDefault(); zrusitRezervaci(btn.dataset.id); });
    });

    listEl.querySelectorAll("button.primary").forEach(btn => {
      if (btn.id !== "bulk-reserve") {
        btn.addEventListener("click", (e) => { e.preventDefault(); rezervovat(btn.dataset.id); });
      }
    });

    // Accordion: přidáme ovládání šipky a aria-expanded
    listEl.querySelectorAll(".acc-header").forEach(h => {
      const toggleBtn = h.querySelector(".group-toggle");
      h.addEventListener("click", (ev) => {
        const body = document.getElementById(h.dataset.target);
        if (!body) return;
        const isHidden = body.classList.toggle("hidden");
        if (toggleBtn) {
          toggleBtn.setAttribute("aria-expanded", (!isHidden).toString());
          toggleBtn.textContent = (!isHidden) ? "▾" : "▸";
        }
      });

      if (toggleBtn) {
        toggleBtn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          const body = document.getElementById(h.dataset.target);
          if (!body) return;
          const isHidden = body.classList.toggle("hidden");
          toggleBtn.setAttribute("aria-expanded", (!isHidden).toString());
          toggleBtn.textContent = (!isHidden) ? "▾" : "▸";
        });
      }
    });

    // Hromadná tlačítka (moje rezervace)
    const bulkSellBtn = document.getElementById("bulk-sell");
    const bulkPaidBtn = document.getElementById("bulk-paid");
    const bulkCancelBtn = document.getElementById("bulk-cancel");

    if (bulkSellBtn) bulkSellBtn.addEventListener("click", bulkSell);
    if (bulkPaidBtn) bulkPaidBtn.addEventListener("click", bulkPaid);
    if (bulkCancelBtn) bulkCancelBtn.addEventListener("click", bulkCancel);

    // Hromadná rezervace dostupných
    const bulkReserveBtn = document.getElementById("bulk-reserve");
    if (bulkReserveBtn) bulkReserveBtn.addEventListener("click", (e) => { e.preventDefault(); openBulkReserveModal(); });

    // --- delegovaný listener pro checkboxy dostupných položek (bulk-available) ---
    const availableList = document.getElementById("available-list");
    if (availableList) {
      availableList.addEventListener("change", (ev) => {
        const target = ev.target;
        if (target && target.classList && target.classList.contains("bulk-available")) {
          updateBulkReserveState();
        }
      });
      updateBulkReserveState();
    }
  }

  async function rezervovat(id) {
    const inputCena = document.getElementById("cena-" + id);
    const inputZakaznik = document.getElementById("zakaznik-" + id);
    const novaCena = parseInt(inputCena.value, 10);
    const zakaznik = (inputZakaznik.value || "").trim();

    if (!zakaznik) {
      alert("Zadejte jméno zákazníka.");
      return;
    }

    if (!novaCena || isNaN(novaCena) || novaCena <= 0) {
      alert("Zadejte platnou cenu.");
      return;
    }

    await supabase
      .from("items")
      .update({
        status: "Rezervováno",
        price: novaCena,
        reserved_by: currentTraderName,
        reserved_for: zakaznik,
        reserved_at: new Date().toISOString()
      })
      .eq("id", id)
      .eq("status", "K prodeji");

    nacist();
  }

  async function oznacitProdej(id) {
    await supabase
      .from("items")
      .update({ status: "Prodáno" })
      .eq("id", id);
    nacist();
  }

  async function oznacitZaplaceno(id) {
    await supabase
      .from("items")
      .update({
        paid: true,
        status: "Zaplaceno"
      })
      .eq("id", id);
    nacist();
  }

  // Upraveno: admin i běžný uživatel mohou zrušit rezervaci; admin může zrušit i prodané/zaplacené
  async function zrusitRezervaci(id) {
    await supabase
      .from("items")
      .update({
        status: "K prodeji",
        reserved_by: null,
        reserved_for: null,
        reserved_at: null,
        paid: false
      })
      .eq("id", id);
    nacist();
  }

  async function bulkSell(e) {
    if (e && e.preventDefault) e.preventDefault();
    const ids = getSelectedIds("#rez");
    if (ids.length === 0) {
      alert("Nic není vybráno v sekci Rezervované.");
      return;
    }

    await supabase
      .from("items")
      .update({ status: "Prodáno" })
      .in("id", ids);

    nacist();
  }

  async function bulkPaid(e) {
    if (e && e.preventDefault) e.preventDefault();
    const ids = getSelectedIds("#pro");
    if (ids.length === 0) {
      alert("Nic není vybráno v sekci Prodáno.");
      return;
    }

    await supabase
      .from("items")
      .update({ status: "Zaplaceno", paid: true })
      .in("id", ids);

    nacist();
  }

  // Upravené bulkCancel: admin může zrušit i prodané/zaplacené položky
  async function bulkCancel(e) {
    if (e && e.preventDefault) e.preventDefault();
    const ids = getSelectedIdsForBulkCancel();
    if (ids.length === 0) {
      alert("Nic není vybráno pro zrušení.");
      return;
    }

    await supabase
      .from("items")
      .update({
        status: "K prodeji",
        reserved_by: null,
        reserved_for: null,
        reserved_at: null,
        paid: false
      })
      .in("id", ids);

    nacist();
  }

  // Modal – otevření
  function openBulkReserveModal() {
    const ids = getSelectedAvailableIds();
    if (ids.length === 0) return;

    brmCountEl.textContent = ids.length;
    brmCustomerEl.value = "";
    brmPriceEl.value = 1000000;
    brmPriceEl.placeholder = "1 000 000 Kč — za jednu akcii";
    brmMsgEl.textContent = "";

    brmEl.classList.remove("hidden");
    brmEl.setAttribute("aria-hidden", "false");
  }

  function closeBulkReserveModal() {
    brmEl.classList.add("hidden");
    brmEl.setAttribute("aria-hidden", "true");
  }

  async function submitBulkReserve() {
    const ids = getSelectedAvailableIds();
    if (ids.length === 0) {
      brmMsgEl.textContent = "Není vybrána žádná položka.";
      return;
    }

    const zakaznik = (brmCustomerEl.value || "").trim();
    const cena = parseInt(brmPriceEl.value, 10);

    if (!zakaznik) {
      brmMsgEl.textContent = "Zadejte jméno zákazníka.";
      return;
    }

    if (!cena || isNaN(cena) || cena <= 0) {
      brmMsgEl.textContent = "Zadejte platnou cenu.";
      return;
    }

    brmMsgEl.textContent = "";
    brmEl.classList.add("processing");

    await supabase
      .from("items")
      .update({
        status: "Rezervováno",
        price: cena,
        reserved_by: currentTraderName,
        reserved_for: zakaznik,
        reserved_at: new Date().toISOString()
      })
      .in("id", ids)
      .eq("status", "K prodeji");

    brmEl.classList.remove("processing");
    closeBulkReserveModal();
    nacist();
  }

  // Modal eventy
  brmCancelBtn.addEventListener("click", (e) => { e.preventDefault(); closeBulkReserveModal(); });
  brmBackdrop.addEventListener("click", (e) => { e.preventDefault(); closeBulkReserveModal(); });
  brmSubmitBtn.addEventListener("click", (e) => { e.preventDefault(); submitBulkReserve(); });

  loginBtn.addEventListener("click", (e) => { e.preventDefault(); handleLogin(); });

  loginPasswordInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") { e.preventDefault(); handleLogin(); }
  });

  logoutBtn.addEventListener("click", () => {
    showLogin();
    listEl.textContent = "";
  });

  showLogin();
});
</script>
</body>
</html>
